---
title: "AMOD 5250 - R - Final Project"
author: "Wasif Khan"
date: "2020/12/11"
output: html_notebook
---

# A. Data Summary

<style>
body {
text-align: justify}
</style>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The data provided was the American Community Survey of 2018. The survey had around 15.8 million observations (respondents) and around 281 columns (variables). Each person (respondent) was assigned a weight variable (PWGT), partly due to privacy concerns, and a frequency of individuals who have the similar probability of being sampled (smaller probability of being sampled meant higher weight). For my project, I will be using ~ 10 columns. Some of these columns include, age, sex, race, income (inflation adjusted), worker class (job category), and education attainment. In my report I will be looking at how post secondary education attainment influences income. Does having a STEM degree lead to a higher income? Does working longer hours necessarily mean higher income? Is there income disparity between different the largest races for the same education attainment? This report will be split up into 3 parts. In part A I will be provide a general summary of the data I have chosen to look at including some graphs and tabular summaries. In part B I will discuss the methodology; i.e the approach I have taken to exploring the dataset, what values have been ignored and what are some analysis I thought would have produced interesting results but didn't. In part C, I will talk about my findings; this will include running 2 ANOVA tests, one t-test and a Linear and Multi-linear regression. And finally, in the discussion section, I will talk about what conclusions can be drawn from the findings, and what are the limitations of my analysis.

```{r, message=FALSE, warning=FALSE, include=FALSE, eval=FALSE}
# Libraries used in this report.
install.packages("dplyr")
install.packages("readr")
install.packages("ggplot2")
install.packages("data.table")
install.packages("forcats")
install.packages("Hmisc")
install.packages("weights")
install.packages("reshape2")
install.packages("lubridate")
install.packages("maps")
install.packages("viridis")
install.packages("highcharter")
install.packages("usmap")
install.packages("tidyr")
install.packages("psych")
install.packages("datarium")
install.packages("rstatix")
install.packages("emmeans")
install.packages("onewaytests")
install.packages("kableExtra")
install.packages("spatstat")
```


```{r, message=FALSE, warning=FALSE, cache=TRUE, include=FALSE}
library(dplyr)
library(readr)
library(ggplot2)
library(data.table)
library(forcats)
library(Hmisc)
library(weights)
library(reshape2)
library(lubridate)
library(maps)
library(viridis)
library(highcharter)
library(usmap)
library(tidyr)
library(psych)
library(datarium)
library(rstatix)
library(emmeans)
library(onewaytests)
library(weights)
library(kableExtra)
library(spatstat)

# load the datasets
# Selecting the columns I need
columns <- c("SERIALNO", "REGION", "ST", 
             "ADJINC", "PWGTP", "AGEP", "COW","MAR", "PAP", "SCHL", "SEX", 
             "WAGP", "WKHP", "ANC1P", "ESP", "ESR", "FOD1P",  "HICOV", "INDP", 
             "OCCP", "PERNP", "PINCP", "POVPIP", 
             "RAC1P", "SCIENGP",  "SOCP")

df1 <- fread("psam_pusa.csv", header = TRUE, select = columns, data.table = FALSE, 
             stringsAsFactors = FALSE)

df2 <- fread("psam_pusb.csv", header = TRUE, select = columns, data.table = FALSE, 
             stringsAsFactors = FALSE)

df3 <- fread("psam_pusc.csv",header = TRUE, select = columns, data.table = FALSE, 
             stringsAsFactors = FALSE)

df4 <- fread("psam_pusd.csv",header = TRUE, select = columns, data.table = FALSE, 
             stringsAsFactors = FALSE)

mydata3 <- rbind(df1, df2, df3, df4)
remove(df1, df2, df3, df4, columns)

# Rename the columns
mydata <- mydata3 %>%
  rename(
    serialno = SERIALNO, region = REGION, state = ST,
    inc_adjustment = ADJINC, person_weight = PWGTP, age = AGEP,
    worker_class = COW, marital_status = MAR, welfare = PAP,
    educ_attainment = SCHL, sex = SEX, current_wage = WAGP, hrs_worked = WKHP, 
    ancestry = ANC1P, employ_parents = ESP, employment_status = ESR,degree = FOD1P, 
    health_coverage = HICOV, jobs_industry = INDP,
    occupation = OCCP, earnings = PERNP, income = PINCP,
    incometopoverty = POVPIP, race = RAC1P, stem = SCIENGP, occ_class = SOCP
    )

remove(mydata3)

# renaming sex
mydata$sex <- factor(mydata$sex, levels = c(1,2), labels = c("Male", "Female"))

# rename state
mydata$state <- factor(mydata$state, levels = c(1,2,4,5,6,8,9,10,11,12,13,15,16,17,18,
                                                19,20,21,22,23,24,25,26,27,28,29,30,31,
                                                32,33,34,35,36,37,38,39,40,
                                                41,42,44,45,46,47,48,49,50,51,53,54,55,56,72), 
                       labels = c("Alabama", "Alaska", "Arizona", "Arkansas",
                                  "California", "Colorado", "Connecticut",
                                  "Delaware", "DC", "Florida", "Georgia",
                                  "Hawaii", "Idaho", "Illinois", "Indiana",
                                  "Iowa", "Kansas", "Kentucky", "Louisiana",
                                  "Maine", "Maryland", "Massachusetts", 
                                  "Michigan", "Minnesota", "Mississippi",
                                  "Missouri", "Montana", "Nebraska", "Nevada", 
                                  "New Hampshire", "New Jersey", "New Mexico", 
                                  "New York", "North Carolina", "North Dakota", 
                                  "Ohio", "Oklahoma", "Oregon", "Pennsylvania", 
                                  "Rhode Island", "South Carolina", "South Dakota",
                                  "Tennessee", "Texas", "Utah", "Vermont", 
                                  "Virginia", "Washington", "West Virginia",
                                  "Wisconsin", "Wyoming", "PuertoRico"
                                  ))
# renaming region
mydata$region <- factor(mydata$region, levels = c(1,2,3,4,9), labels = c("NorthEast", "MidWest", 
                                                                   "South", "West", "PuertoRico"))
# creating age-grouping
mydata <- mydata %>%
  mutate(agegroup = factor(case_when(
    age >= 65 ~ "senior",
    age >= 21 & age <=64 ~ "adult",
    age >= 15 & age <= 20 ~ "youth",
    age <=15 ~ "children"
  )))

# rename worker_class
# N/A - Not in universe (less than 16 years old/NILF who last worked more than 5 years ago or never worked)
mydata$worker_class <- factor(mydata$worker_class, levels = c(1:9), labels = c(
  "Private", "NonProfit", "LocalGovt", "StGovt",
  "FedGovt", "SelfEmployed", "SoleProp", "SolePropNoPay", "Unemployed"
))


# rename marital status
mydata$marital_status <- factor(mydata$marital_status, levels = c(1:5), 
                         labels = c("married", "widowed", "divorced", 
                          "separated", "unmarried/under15"))

# rename education
# N/A (less than 3 years old)
mydata$educ_attainment <- factor(mydata$educ_attainment, levels = c(1:24), 
                                 labels = c("NoSchooling", "preschooling",
                                 "kingergarten", "grade1", "grade2", "grade3",
                                 "grade4", "grade5", "grade6", "grade7", "grade8",
                                 "grade9", "grade10", "grade11", "grade12-no diploma",
                                 "HighSchool", "GED/Alternative", "collage_less1yr",
                                 "incompleteCollage", "AssociateDegree",
                                 "Bachelors", "Masters", "ProfessionalDegree", "Doctorate"))

# renaming Employed parents
# N/A - (not own child of householder, and not child in subfamily)
mydata$employ_parents <- factor(mydata$employ_parents, levels = c(1:8),
                         labels = c("BothParentsWrk", "BothDadWrk",
                                    "BothMumWrk", "BothNeitherWrk",
                                    "SingleWrkDad", "SingleUnempDad",
                                    "SingleWrkMum", "SingleUnempMum"))

# employment status
# N/A - (less than 16 years old)
mydata$employment_status <- factor(mydata$employment_status, levels = c(1:6),
                            labels = c("CivEmployedProper", "CivEmployednotwork",
                            "unemployed", "militarywork", "militaryunemployed",
                            "NotInLabourForce"))

# renaming health-coverage
mydata$health_coverage <- factor(mydata$health_coverage, levels = c(1:2),
                                 labels = c("HasCoverage", "NoCoverage"))

# renaming race
mydata$race <- factor(mydata$race, levels = c(1:9),
               labels = c("White", "Black",
                      "Native", "Alaska_native",
                      "MixedNativeAndAlaskan", "Asian",
                      "Hawaiian", "other", "TwoOrMore"))

# renaming stem
# N/A - (less than a bachelor's degree)
mydata$stem <- factor(mydata$stem, levels = c(1,2), labels = c("STEMdegree", "NonSTEMdegree"))

# Adjusting income for inflation
mydata <- mydata %>%
  mutate(
    adjustedincome = income*(inc_adjustment/1000000))

# save(mydata, file = "mydata.RData")
# load("mydata.RData")

```



**Note:** In all the tables, graphs and analysis below I have accounted for inflation and person weights. Inflation weight is accounted for by multiplying the `r colnames(mydata)[4]` data provided with the un-adjusted reported income. This is captured in a new column added to the dataset, `r colnames(mydata)[28]`. This is the income column used when referring to "income" in rest of the report.  Person weights are accounted for where applicable with including `r colnames(mydata)[5]` in the appropriate graph, table or analysis. The reader can assume that the person weights have been accounted for in all graphs and analysis in the report below.

**Note:** regarding NAs. In many cases through out my analysis I have filtered out the NA values. The NAs were not relevant in my analysis. In the following bullet points, I will highlight some of the common NAs that I regularly filter out from my data analysis. The variable description is taken from ACS Population data dictionary.

* In worker class column - NA refers to people less than 16 or never worked/not worked in 5 years.
* In education attainment column - NAs refer to people less than 3 years old.
* In the STEM columns - NA refers to those holding less than a bachelors degree
* In adjusted income column - NA refers to those below 15 years of age. 
* In hours worked column - NA refers to those who are less than 16 or never worked/not worked in 12 months.
* In any other analysis where I filter NAs, I will explain in the description of that analysis.


### A.1 - Proportion of races and sex in the dataset.

```{r, echo=FALSE}
f <- wpct(mydata$race, weight = mydata$person_weight)
f %>%
  kbl(caption = "Proportion of races") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```

```{r, echo=FALSE}
g <- wpct(mydata$sex, weight = mydata$person_weight)
g %>%
  kbl(caption = "Proportion of Sex") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```

```{r, include=FALSE, error=FALSE, warning=FALSE}
a1 <- f[[1]]*100
a2 <- f[[2]]*100
a3 <- f[[6]]*100
a4 <- g[[1]]*100
a5 <- g[[2]]*100
```


Since I will be working with race, sex and income data quite a bit in this dataset, I wanted to see what is the racial makeup of the ACS 2018 dataset. In the table above we see the breakdown of the 9 main races in the dataset, we see that White (`r a1`%) make up biggest proportion in the dataset, followed by Blacks (`r a2`%) and Asians (`r a3`%). We also see that in our dataset there are more females (`r a5`%) than males(`r a4`%).

```{r, include = F}
remove(f,g)
```


### A.2 Proportion of Educational attainment by race

```{r, echo=FALSE}
mydata %>%
  filter(race %in% c("White", "Black", "Asian")) %>%
  filter(educ_attainment %in% c("HighSchool", "ProfessionalDegree", "Bachelors", "Masters", "Doctorate", "AssociateDegree")) %>%
  count(race, educ_attainment) %>%
  group_by(race) %>%
  mutate(percent = (n/sum(n)) * 100) %>%
  ungroup() %>%
  hchart("column", hcaes(x = educ_attainment, y=percent, group = race))
```

In the above section we saw that the 3 largest races were White, Black and Asian. I wanted to see if there was a difference is the proportion of educational attainment by race. Here is a graph showing the educational attainment by race. Eventually in this report I want to explore whether a post-secondary degree affects income, so I want to get a clear idea of educational attainment of the 3 largest races in ACS. This is the reason, I have picked only 6 education attainment levels, High School completion, Professional Degree, Bachelors, Masters, Associates degree and Doctorate. From the graph we see among Blacks the biggest proportion of education attainment is high school diploma, and make up the smallest of the 4 in post secondary education attainment. On the other hand, we see that post-secondary levels of education is highest among Asians. 


### A.3 Median income by state

```{r, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
aa <- mydata %>%
  select(adjustedincome, state, person_weight) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(state) %>%
  summarise(Median_income = weighted.median(adjustedincome, person_weight))
plot_usmap(data = aa, values = "Median_income", colour = "red") +
  scale_fill_continuous(name = "Weighted Median income by State (2018)", label = scales::comma) + 
  theme(legend.position = "right")
```
```{r, include=FALSE}
remove(aa)
```

I wanted to see how income was distributed across the entire country. Here I calculated the median income by state and displayed it on a map. Unsurprisingly we see that more northern states have higher median income than southern states. I have chosen (weighted) median instead of mean as mean is more sensitive to outliers.


### A.4 STEM degree vs. Non-STEM degree holders

```{r, echo=FALSE}
steem <- mydata %>%
  select(stem, person_weight) %>%
  filter(!is.na(stem))
d1 <- wpct(steem$stem, weight = steem$person_weight)
d1 %>%
  kbl(caption = "Proportion Post Secondary degrees in STEM field and Non-STEM field") %>%
    kable_classic(full_width = F, html_font = "Cambria")
```

```{r, include=FALSE, error=FALSE, warning=FALSE}
b1 <- d1[[2]]*100
b2 <- d1[[1]]*100
```


STEM stands for Science, Technology, Engineering and Math. I wanted to see how much of the post-secondary holders is in the STEM field. In the methodology I explore relation of STEM degree holders with income and race. Above is a (weighted) proportion table of STEM degree holders and Non-STEM degree holders. From this we see that about `r b1`% of the post secondary degrees are in Non-STEM-fields and about `r b2`% are in STEM fields. 

```{r, include=FALSE}
remove(steem, d1)
```

### A5. Job Category of the population. 

```{r, echo=FALSE}
sc <- mydata %>%
  select(worker_class, person_weight) %>%
  filter(!is.na(worker_class))
d2 <- wpct(sc$worker_class, weight = sc$person_weight)
d2 %>%
  kbl(caption = "Proportion of workers by job category") %>%
    kable_classic(full_width = F, html_font = "Cambria")
```

I wanted to see what area of employment most of the people in the dataset are engaged in. I chose to go with the "Class of Worker" variable as it captures the broad fields of employment. The ACS dataset provides other variables that has further granularity, however I have chosen not to use those as such granularity is beyond the scope of my analysis. From the table above we see that most people are employed in the private sector. 

```{r, include=F, error=FALSE, warning=FALSE}
remove(sc, d2)
```

### A6. Mean hours worked by race.

```{r, echo=FALSE, message=FALSE}
vb <- mydata %>%
  select(race, hrs_worked, person_weight, sex) %>%
  filter(!is.na(hrs_worked)) %>%
  group_by(race, sex) %>%
  summarise(MeanHrsWorked = weighted.mean(x=hrs_worked, w= person_weight))
vb %>%
  kbl() %>%
  kable_classic_2(full_width = F)
```

In the analysis I will work income and work hours data. I wanted to see the mean hours worked by all the races mentioned and if there was any notable differences between them. We see that for every race, hours worked by males is higher than females.

```{r, include=F}
remove(vb)
```

### A7. Hours worked and sex

```{r, echo=F, message=FALSE, warning=FALSE}
mydata %>%
  filter(!is.na(hrs_worked)) %>%
  filter(!is.na(adjustedincome)) %>%
  select(adjustedincome, sex, hrs_worked, person_weight) %>%
  group_by(sex, hrs_worked) %>%
  summarise(avg.inc = weighted.mean(adjustedincome, person_weight)) %>%
  hchart("scatter", hcaes(x = hrs_worked, y= avg.inc, group = sex))
```

The analysis above is to test whether there is any difference in average income for the hours worked by Male vs Female. The purpose of this analysis is to check does working longer hours necessarily result in higher incomes, or is there a difference in income earned for the same hours worked among sex. We observe that at almost every hours worked, females earn less than males.


### A8. Educational attainment and Average Income

```{r, echo=FALSE, message=FALSE}
fy <- mydata %>%
  filter(educ_attainment %in% c("HighSchool", "ProfessionalDegree", "Bachelors", "Masters", "Doctorate","AssociateDegree")) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(educ_attainment) %>%
  summarise(avg.inc = weighted.mean(adjustedincome, person_weight))

hchart(fy, type = "column", hcaes(x = educ_attainment, y = avg.inc)) %>%
  hc_xAxis(title = list(text = "<b>Educational attainment<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Average Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Educational attainment<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
```

```{r, include=FALSE, error=FALSE, warning=FALSE}
b3 <- fy[[5,1]]
```


Earlier in the report I mentioned that I will be working with income data and education data for a lot of my analysis. Therefore, it would be helpful to look at which educational qualification allows an individual to earn the highest income on average. From this we see that `r b3` holders on average earn the highest income.

```{r, include=F}
remove(fy)
```

### A9. Job category and Income

```{r, echo=FALSE, message=FALSE}
hj <- mydata %>%
  filter(!worker_class %in% c("Unemployed", "SoleProp", "SolePropNoPay")) %>%
  filter(!is.na(worker_class)) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(worker_class) %>%
  summarise(avg.inc = weighted.mean(adjustedincome, person_weight))

hchart(hj, type = "column", hcaes(x = worker_class, y = avg.inc)) %>%
  hc_xAxis(title = list(text = "<b>Job Category<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Average Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Job Category<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
```

```{r, include=FALSE, error=FALSE, warning=FALSE}
b4 <- hj[[5,1]]
```


As mentioned earlier, I will be working with income data and job category for a lot of my analysis. Therefore, it would be helpful to look at which  job category allows an individual to earn the highest income on average. I have left out Sole Proprietors and unemployed individuals out of this analysis as I am interested in know which field of employment generate highest income. Income of those who own their own business is out of the scope of this report. We see here than on average `r b4` Employee earns the highest average income.

```{r, include=F}
remove(hj)
```


# B. Methdology

In the data summary section above I presented and explained some graphs and table that stood out to me. I will use those data to further my explanation in this section and the findings section. Based on the data summaries presented above we see that there are relationships between race and its affect on income, sex, hours worked and education attainment. In this section and the findings section, I will explore these relationships.

### B1. Income distribution

```{r, message=F, echo=F, warning=F}
inco <- mydata %>%
  select(adjustedincome, person_weight, agegroup) %>%
  filter(!agegroup %in% "children") %>%
  filter(!is.na(adjustedincome)) %>%
  mutate(TaxBracket = factor(case_when(
    adjustedincome >= 500001 ~ "Bracket 7",
    adjustedincome >= 200001 & adjustedincome <= 500000 ~ "Bracket 6",
    adjustedincome >= 157501 & adjustedincome <= 200000 ~ "Bracket 5",
    adjustedincome >= 82501 & adjustedincome <= 157500 ~ "Bracket 4",
    adjustedincome >= 38701 & adjustedincome <= 82500 ~ "Bracket 3",
    adjustedincome >= 9526 & adjustedincome <= 38700 ~ "Bracket 2",
    adjustedincome >= 0 & adjustedincome <= 9525 ~ "Bracket 1",
    adjustedincome < 0 ~ "NegativeIncome")))
ggplot(data=subset(inco, !is.na(TaxBracket)), aes(x=TaxBracket, weight = person_weight)) + 
  geom_histogram(stat = "count", color="black", fill="lightblue", linetype="dashed") + 
  scale_y_continuous(name = "Count (millions)",labels = function(y) y / 1000000)
```

Since I will be working with income data, I wanted to see how income is distributed across the population. The ACS data is top coded for privacy reasons. The data is also vast and contains extreme outliers. To adjust for this, I have looked at the 2018 income tax brackets. Based on that data I will be arranging the population in 7 tax brackets from the individual brackets of 2018 tax year.

[The Full Breakdown of Tax Brackets can be found here](https://en.wikipedia.org/wiki/Income_tax_in_the_United_States#Marginal_tax_rates_for_2018). 

In addition, I will be filtering out the "children" age group as they are not currently in the labour force. I will also be filtering out NAs as they are not currently income earners as per the ACS data dictionary. Above is a barchart showing which tax brackets most Americans fall. We see that **Tax Bracket 2**, **9,526 – $38,700** is where most of the population falls. Next largest bracket is **Tax Bracket 1, 0 – 9,525**, after that is **Tax Bracket 3, 38,701 – 82,500**. 

```{r, include=FALSE}
remove(inco)
```

### B2. Income vs Race vs Educational Attainment

```{r, message=F, echo=F}
tt <- c("HighSchool", "ProfessionalDegree", "Bachelors", "Masters", "Doctorate", "AssociateDegree")
rr <- c("White", "Black", "Asian")
ww <- mydata %>%
  filter(educ_attainment %in% tt) %>%
  filter(race %in% rr) %>%
  filter(agegroup == "adult") %>%
  group_by(race, educ_attainment) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight))

hchart(ww, type = "bar", hcaes(x = educ_attainment, y = avginc, group = race)) %>%
  hc_xAxis(title = list(text = "<b>Educcation<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Race vs Education<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
```

Here I want to explore the different average income for different educational attribute for 3 of the largest races in out ACS data set, White, Black and Asian. In the graph above in data summary section, we saw what percentage different educational attainment is composed of the 3 largest races. Here I will analyse average income grouped by educational attainment and race. I have also filtered age group to show just the Adult population in the dataset.

We see here that the highest income among all educational attainment is for Whites with a professional degree, closely followed by Asians with a professional degree. We see that for all education attainment, Blacks have the lowest average income. The income disparity is lowest for just high school graduates but the difference is much higher among post secondary levels of education.


```{r, include=F}
remove(ww, tt, rr)
```

### B3. Educational attainment and sex and Income

```{r, echo = F, message=FALSE}
e <- c("HighSchool", "ProfessionalDegree", "Bachelors", "Masters", "Doctorate", "AssociateDegree")
c <- mydata %>%
  filter(educ_attainment %in% e) %>%
  filter(agegroup == "adult") %>%
  group_by(sex, educ_attainment) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight))

hchart(c, type = "bar", hcaes(x = educ_attainment, y = avginc, group = sex)) %>%
  hc_xAxis(title = list(text = "<b>Education<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Sex vs Education<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
```

In the scatter plot above in the data summary section, I examined a relationship hours worked and average income grouped by sex. Almost consistently throughout the plot, we observe that for a given number of hours worked, male income for higher than female income. I wanted to explore whether educational qualification had anything to do with the higher income of males. This is a chart showing the average income for Males and Females grouped by the different educational qualification. I am interested in high school and post secondary, only those educational qualification was chosen. The same trend as the hours worked scatter plot is reflected here; for each educational qualification we see that female average income is less than male average income.

```{r, include=F}
remove(c,e)
```

### B4. Race and Job Type. Sex and Job Type. 
In the previous graphs, we saw that for every every educational level, average income of Blacks was less than White and Asian. We also saw that for every every educational level, average income of female was less than male. I wanted to explore this relationship further by investigating whether there is any affect of Job category on their income. Is one sex or race overrepresented in a certain job category? I have left out Sole Proprietors and unemployed individuals out of this analysis as I am interested in know which field of employment most people from the 3 largest races are employed in.


```{r, message=FALSE, echo=FALSE}
mydata %>%
  filter(!is.na(worker_class)) %>%
  filter(!worker_class %in% c("Unemployed", "SoleProp", "SolePropNoPay")) %>%
  filter(race %in% c("White", "Black", "Asian")) %>%
  count(worker_class, race) %>%
  group_by(race) %>%
  mutate(percent = (n/sum(n)) * 100) %>%
  ungroup() %>%
  ggplot(aes(x=worker_class, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer(palette = "Set2") +
  ggtitle("Race and Job category")
```
```{r, message=FALSE, echo=FALSE, warning=F}
mydata %>%
  filter(!is.na(worker_class)) %>%
  filter(!worker_class %in% c("Unemployed", "SoleProp", "SolePropNoPay")) %>%
  count(worker_class, sex) %>%
  group_by(sex) %>%
  mutate(percent = (n/sum(n)) * 100) %>%
  ungroup() %>%
  ggplot(aes(x=worker_class, y = percent, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer(palette = "Set3") +
  ggtitle("Sex and Job category")
```
We see there that there is no notable difference between the races for each job category. 

In the sex and job category, couple things catches attention. We see that females employed in non-profit are notably higher than Males. In state and local, government there is a higher percentage of females employed than male, but a higher percentage of males is seen for the Federal govt employment, private work and self-employment.


### B5. STEM degree and income. STEM degree and race.

In the previous table in the data summary section we saw that around two thirds of the population did not have a STEM degree. I wanted to see whether holding a STEM degree resulted in higher average income. Unsurprisingly we see that STEM degree holders on average earn a higher income regardless of sex or race.

```{r, message=FALSE, echo=FALSE, warning=FALSE}
yu <- mydata %>%
  filter(!is.na(stem)) %>%
  group_by(sex, stem) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight))

hchart(yu, type = "bar", hcaes(x = stem, y = avginc, group = sex)) %>%
  hc_xAxis(title = list(text = "<b>STEM<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Sex vs Stem<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
```
```{r, include=FALSE}
remove(yu)
```

```{r, message=FALSE, echo=FALSE}
test <- mydata %>%
  filter(!is.na(stem)) %>%
  group_by(race, stem) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight))

hchart(test, type = "column", hcaes(x = stem, y = avginc, group = race)) %>%
  hc_xAxis(title = list(text = "<b>STEM<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Race vs STEM degree<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
remove(test)
```


### B6. Average hours worked vs Income vs Race

So far we have seen that the average income for Blacks are less than Asian and White across various metrics. I wanted to see whether hours worked has a huge affect in it. In the graph below for almost every hour worked, we see that the average income for Black is less than that of Whites and Asians. There is some variability between Asians and Whites. At lower hours worked (<30) we observe that the mean income for Whites is slightly higher than Asians, but as the hours worked rises, we see that the average income of Asians are notably higher than Whites.

```{r, message=FALSE, echo=FALSE}
rr <- c("White", "Black", "Asian")
tt <- c("HighSchool", "ProfessionalDegree", "Bachelors", "Masters", "Doctorate", "AssociateDegree")
mydata %>%
  filter(race %in% rr) %>%
  filter(!is.na(hrs_worked)) %>%
  filter(!is.na(adjustedincome)) %>%
  select(adjustedincome, race, hrs_worked, person_weight) %>%
  group_by(race, hrs_worked) %>%
  summarise(avg.inc = weighted.mean(adjustedincome, person_weight)) %>%
  hchart("scatter", hcaes(x = hrs_worked, y= avg.inc, group = race))
```

```{r, include=FALSE, error=FALSE, warning=FALSE}
remove(tt,rr)
```


In addition to these analysis above, I also looked at whether having parent(s) who are employed have an effect on the income earned by individuals and their education attainment.I also wanted to look at how income level affects health coverage. Whether being employed by the military results in higher income. Healthcare coverage by race. These analysis did not produce any meaningful results. I have included them in the appendix 2 for viewing purposes.

# Findings

**What analysis did I finally settle on**  

In the above sections I explored relationships between variables like sex, income, race, hours worked, and it appears that there is a clear relationship between education attainment and income. There also seems to be a relationship between type of jobs and income where, almost all levels of government worker earns higher than a private sector worker. This can be because there is overwhelmingly more private sector workers than government employees. I will do ANOVA test to test these to claims. I will also perform a t-test to test whether the mean incomes for STEM degree holders and Non-STEM degree holders are significantly different. Finally, I will perform a linear regression to see how much of the change in income can be explained just by hours worked. I will also perform as multiple linear regression to see how much of change in income can be explained by sex, education attainment and hours worked.

### C1. Income ineqality between White and Black in USA

```{r, message=FALSE, echo=FALSE}
yy <- mydata %>%
  select(adjustedincome, race, person_weight, state) %>%
  filter(race %in% c("White", "Black")) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(state, race) %>%
  summarise(Median_income = weighted.median(adjustedincome, person_weight)) 

yt <- spread(yy, key = race, value = Median_income)

ye <-yt %>%
  mutate(IncomeDifference = White - Black)
ye %>%
  select(state, IncomeDifference) %>%
  arrange(desc(IncomeDifference))
```
```{r, message=FALSE, echo=FALSE}
plot_usmap(data = ye, values = "IncomeDifference", colour = "green") +
  scale_fill_continuous(name = "Median income Disparity between Blacks and White", low = "grey", high = "blue", label = scales::comma) + 
  theme(legend.position = "right")
```

In the above analysis we have seen that at every metric accessed, there was clear inequality of income between Whites and Black in the ACS dataset. In the graph and table I explore in what state is income inequality the highest. A clear outlier between the (weighted) median average income between the races is Washington DC where the median difference is around **$48,000**. This could likely be due to the fact that it is the capital city and hosts most lobbyists and politicians within which the black population is relatively small. There was no state where the income difference was negative. 

```{r, message=FALSE, echo=FALSE}
remove(ye,yt,yy)
```


### C2. ANOVA test - education attainment and average income

Using ANOVA test I will see if the mean incomes for people with different post-secondary educational qualifications are significantly different from each other. The different levels of post secondary education chosen is "Professional Degree", "Bachelors", "Masters", "Doctorate", "Associate Degree". 

ANOVA model `adjustedincome ~ educ_attainment, weight = person_weight`

**Ho:** All levels of post-secondary education have the same mean income.

**Ha:** At least one of the mean income is different.

```{r, message=FALSE, echo=FALSE}
bn <- mydata %>%
  select(adjustedincome, person_weight, educ_attainment) %>%
  filter(!is.na(adjustedincome)) %>%
  filter(educ_attainment %in% c("ProfessionalDegree", "Bachelors", "Masters", "Doctorate", "AssociateDegree")) %>%
  group_by(educ_attainment)

rt <- aov(adjustedincome ~ educ_attainment, data = bn, weight = person_weight)
summary(rt)
```

```{r, message=FALSE, echo=FALSE}
remove(bn, rt)
```

We see that the **P** value is of <2e-16 is very small compared to our significance level of alpha = 0.05. Therefore, we can reject *Ho* and conclude that the mean income for different levels of post-secondary education is statistically different.


### C3. ANOVA test - Job Category and average income

Using ANOVA test I will see if the mean incomes for different types of government jobs are significantly different from each other. The 3 levels of government job chosen here is Federal, State, and Local government job.

ANOVA model `adjustedincome ~ worker_class, weight = person_weight`

**Ho:** All types of government job have the same mean income.

**Ha:** At least one of the mean income is different.

```{r, message=FALSE, echo=FALSE}
b <- mydata %>%
  select(person_weight, adjustedincome, worker_class) %>%
  filter(!is.na(adjustedincome)) %>%
  filter(!is.na(worker_class)) %>%
  filter(!worker_class %in% c("Unemployed", "SoleProp", "SolePropNoPay", "Private", "NonProfit",
                              "SelfEmployed")) %>%
  group_by(worker_class)
av <- aov(adjustedincome ~ worker_class, data = b, weight = person_weight)
summary(av)
```

```{r, message=FALSE, echo=FALSE}
remove(b,av)
```

We see that the **P** value is of <2e-16 is very small compared to our significance level of alpha = 0.05. Therefore, we can reject *Ho* and conclude that the mean income for different types of government jobs are statistically different.


### C4. Two sample t-test

I will perform a two sample t-test to test whether the mean incomes for STEM degree holders and non-STEM degree holders are statistically different. I will select only adjusted income and stem column from my dataset. I will filter out NAs as those refer to people not in labour force and non-post secondary degree holders in adjusted income and stem column respectively.

```{r, message=FALSE, echo=FALSE}
fh<- mydata %>%
  select(stem, adjustedincome) %>%
  filter(!is.na(stem)) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(stem) %>%
  arrange(adjustedincome)

# Shapiro test to see normality. First 5000 since dataset is huge and can't do shapiro test on a size beyond 5000.
stest <- shapiro.test(fh$adjustedincome[0:5000])
# p value is less than 0.05

c1 <- fh %>%
  mutate(id = row_number()) %>%
  spread(key = stem, value = adjustedincome)
c2 <- c1 %>%
  na.omit()
remove(c1)

bm<- t.test(c2$STEMdegree, c2$NonSTEMdegree, paired=T)
bm
```

```{r, include=FALSE, error=FALSE, warning=FALSE}
b7 <- bm$p.value
b8 <- bm$statistic[[1]]
```

Based on this paired t-test we see a **P** value of `r b7` and t-statistic of `r b8`, we can reject the Ho and say that the differences in incomes of STEM degree holders and Non-STEM degree holders is significant.

```{r, message=FALSE, echo=FALSE}
remove(c2, fh, stest, bm)
```

### C5. Linear regression

From the scatter plots above we saw that as the hours worked rises, the average income also rose. This it seems like there is a linear relationship between hours worked and income. I will fit a linear regression model using hours worked as explanatory variable to predict the income.

**Ho**: No relation between hours worked and income.

**Ha**: There is a relation between hours worked and income.

First, I will check to see if I am able to conduct a linear regression on my model.

```{r, message=FALSE, echo=FALSE, warning=FALSE}
mydata %>%
  select(hrs_worked, adjustedincome, person_weight) %>%
  group_by(hrs_worked) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight)) %>%
  ggplot(aes(x=hrs_worked, y= avginc)) + geom_point() + geom_smooth(method=lm)
```


```{r, message=FALSE, echo=FALSE, warning=FALSE}
lmodel <- mydata %>%
  select(hrs_worked, adjustedincome, person_weight) %>%
  filter(!is.na(hrs_worked)) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(hrs_worked)

mod1 <- lm(adjustedincome ~ hrs_worked, data = lmodel, weights = person_weight)
summary(mod1)
```

**Correlation between hours worked and income.**
```{r, echo=FALSE}
with(lmodel, cor(hrs_worked, adjustedincome))
```

**Linear regression model is lm(`r x25`)**

```{r, include=FALSE}
mod1.coef <- summary(mod1)$coef
```

```{r, include=FALSE, error=FALSE, warning=FALSE}
x1 <- mod1$coef
x2 <- mod1.coef["hrs_worked", "Estimate"]
x3 <- mod1.coef["(Intercept)", "Pr(>|t|)"]
x4 <- mod1.coef["hrs_worked", "Pr(>|t|)"]
x5 <- mod1.coef["hrs_worked", "Estimate"]
x6 <- mod1.coef["hrs_worked", "Std. Error"]
x7 <- summary(mod1)$adj.r.squared
x8 <- summary(mod1)$fstatistic[["value"]]
x25 <- format(formula(mod1))
```



The model of the relation has an intercept and slope of `r x1` respectively. The slope term in our model says that for every additional hour worked the income will increase by `r x2`.The slope is statistically significant as indicated by the **P** value of `r x3` and `r x4`. This means we can reject the **Ho** and conclude that there is a relationship between hours worked and income. The standard error is the amount by which the linear model will deviate from the regression model. Here we see that income deviates from the regression model `r x5` by `r x6`. The adjusted R-squared shows how well our model fits the actual data. In this model, the R-squared value is `r x7`. This means hours worked only explains about 10% of the variation in income. The F-statistic is also a good indicator of whether there is a relationship between our predictor and the response variables. The further the F-statistic is from 1 the better it is. We have a large F statistic of `r x8`

```{r, include=FALSE}
remove(lmodel, mod1, mod1.coef)
```


### C6. Multiple Linear Regresison 

In the calculation of linear model above we saw that only around 10% of the variation in income can be explained by hours worked. However, it would be important to look at several factors to get a better idea as to what influences income. Here I will run a linear regression to see how hours worked, sex and education attainment affects income. I will only be looking at people with post-secondary degree and High school Diploma.

```{r, message=FALSE, echo=FALSE, warning=FALSE}
lmodel1 <- mydata %>%
  select(hrs_worked, adjustedincome, person_weight, sex, educ_attainment) %>%
  filter(educ_attainment %in% c("HighSchool", "ProfessionalDegree", "Bachelors", "Masters", "Doctorate", "AssociateDegree")) %>%
  filter(!is.na(hrs_worked)) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(hrs_worked)
mod2 <- lm(adjustedincome ~ hrs_worked + sex + educ_attainment, data = lmodel1, weights = person_weight)
summary(mod2)
```

```{r, include=FALSE}
mod2.coef <- summary(mod2)$coef
```

```{r, include=FALSE, error=FALSE, warning=FALSE}
z1 <- mod2$coef[["(Intercept)"]]
z2 <- mod2$coef[["hrs_worked"]]
z3 <- mod2$coef[["sexFemale"]]
z15<- mod2$coef[["educ_attainmentAssociateDegree"]]
z4 <- mod2$coef[["educ_attainmentBachelors"]]
z5 <- mod2$coef[["educ_attainmentMasters"]]
z6 <- mod2$coef[["educ_attainmentProfessionalDegree"]]
z7 <- mod2$coef[["educ_attainmentDoctorate"]]
z8 <- mod2.coef["(Intercept)", "Pr(>|t|)"]
z9 <- sqrt(deviance(mod2)/df.residual(mod2))
z10 <- summary(mod2)$adj.r.squared
z11 <- summary(mod2)$fstatistic[["value"]]
```


The model of the relation has an intercept of `r z1` and slope of `r z2`, `r z3`, `r z15`,`r z4`, `r z5`, `r z6` and `r z7`. From this we can say on for one additional hour worked the average income goes up by almost **$1500**, the average income average females earn about **$20K** less than men. A bachelor degree holder will earn around **$34K** more than someone who just completed High School. A Master degree holder will earn around **$54K** more than someone with a bachelor degree. All the slope values are statistically significant based on their respective **P** values. We see a **P** value of `r z8` for the intercept. Based on this we can conclude there is a statistically significant relationship between income and sex, hours worked and Education attainment. We see that the residual standard error is `r z9`. This is the amount on average our model will deviate from the true regression line. The adjusted R-squared shows how well our model fits the actual data. In this model, the R-squared value is `r z10`. This means that  22.6% of the variation in income can be explained by hours worked, sex and level of education attainment. The F-statistic is also a good indicator of whether there is a relationship between our predictor and the response variables. The further the F-statistic is from 1 the better it is. We have a large F statistic of `r z11`.

```{r, include=FALSE}
remove(lmodel1, mod2, mod2.coef)
```


# Discussion
I started by analysis by taking a look at the different levels of educational attainment among the 3 largest races in the ACS dataset. This further led me to investigate whether education attainment had any affect on the on the income earned by the 3 largest races. I discovered that Blacks on average were earning less than White or Asians regardless of educational attainment. This further led to me access whether hours worked had any effect on average income. I was also interested in whether there was any geographical difference between the income inequality between White and Black. I calculated the differences in median income and displayed them on a graph. Nothing in particular stood out in this analysis. I also looked at mean incomes by job category and sex to see whether there was any significant difference by sex and job category on income.

I also looked at the differences in STEM degree holders and Non-STEM degree holders. An initial graph revealed that for both sexes, STEM degree holders were earning more than Non-STEM degree holders. This further led to me conduct a paired t-test to see if the differences were statistically significant.

However, this is not without its limitations. The data looked at only STEM vs Non-STEM. Does a bachelors in STEM field earn more than a masters degree holder in Non-STEM field? The variation of educational attainment within STEM and Non-STEM was not accessed.

I ran an ANOVA, to test whether the mean incomes of post secondary education. Based on this test I concluded that the incomes for different levels of post secondary education attainment is statistically different. I also ran another ANOVA to see whether the mean incomes for different levels of government job was different. Given the **P** value I concluded that the mean incomes were different. I am more confident in this analysis than the t-test above since here I am not ignoring any cases within the variables like the t-test. Based on this I can be confident on the conclusion.

I conducted two linear regressions, first regression, to see how much of the income can be explained by hours worked. I chose hours worked as I demonstrated in the data summary and methodology section using scatter plots that there seemed to be a linear relationship between hours worked and income. My next regression was to see how income is influenced by hours worked, sex and education attainment. However, the limitation of this is revealed by its adjusted R-squared value. In both cases the models were statistically significant but were only able to explain about 10% and 25% of the variability in income.



# Appendix
```{r, eval=FALSE}
######################################################
################# Data Pre-processing ################
######################################################

# Libraries used in this report.
# Install commands
install.packages("dplyr")
install.packages("readr")
install.packages("ggplot2")
install.packages("data.table")
install.packages("forcats")
install.packages("Hmisc")
install.packages("weights")
install.packages("reshape2")
install.packages("lubridate")
install.packages("maps")
install.packages("viridis")
install.packages("highcharter")
install.packages("usmap")
install.packages("tidyr")
install.packages("psych")
install.packages("datarium")
install.packages("rstatix")
install.packages("emmeans")
install.packages("onewaytests")
install.packages("kableExtra")
install.packages("spatstat")

# Calling the libraries
library(dplyr)
library(readr)
library(ggplot2)
library(data.table)
library(forcats)
library(Hmisc)
library(weights)
library(reshape2)
library(lubridate)
library(maps)
library(viridis)
library(highcharter)
library(usmap)
library(tidyr)
library(psych)
library(datarium)
library(rstatix)
library(emmeans)
library(onewaytests)
library(weights)
library(kableExtra)
library(spatstat)


# Loading the dataset.
columns <- c("SERIALNO", "REGION", "ST", 
             "ADJINC", "PWGTP", "AGEP", "COW","MAR", "PAP", "SCHL", "SEX", 
             "WAGP", "WKHP", "ANC1P", "ESP", "ESR", "FOD1P",  "HICOV", "INDP", 
             "OCCP", "PERNP", "PINCP", "POVPIP", 
             "RAC1P", "SCIENGP",  "SOCP")

df1 <- fread("psam_pusa.csv", header = TRUE, select = columns, data.table = FALSE, 
             stringsAsFactors = FALSE)

df2 <- fread("psam_pusb.csv", header = TRUE, select = columns, data.table = FALSE, 
             stringsAsFactors = FALSE)

df3 <- fread("psam_pusc.csv",header = TRUE, select = columns, data.table = FALSE, 
             stringsAsFactors = FALSE)

df4 <- fread("psam_pusd.csv",header = TRUE, select = columns, data.table = FALSE, 
             stringsAsFactors = FALSE)

mydata3 <- rbind(df1, df2, df3, df4)
remove(df1, df2, df3, df4, columns)


################# Getting the dataset ready ################

# Rename the columns
mydata <- mydata3 %>%
  rename(
    serialno = SERIALNO, region = REGION, state = ST,
    inc_adjustment = ADJINC, person_weight = PWGTP, age = AGEP,
    worker_class = COW, marital_status = MAR, welfare = PAP,
    educ_attainment = SCHL, sex = SEX, current_wage = WAGP, hrs_worked = WKHP, 
    ancestry = ANC1P, employ_parents = ESP, employment_status = ESR,degree = FOD1P, 
    health_coverage = HICOV, jobs_industry = INDP,
    occupation = OCCP, earnings = PERNP, income = PINCP,
    incometopoverty = POVPIP, race = RAC1P, stem = SCIENGP, occ_class = SOCP)

# renaming sex
mydata$sex <- factor(mydata$sex, levels = c(1,2), labels = c("Male", "Female"))

# rename state
mydata$state <- factor(mydata$state, levels = c(1,2,4,5,6,8,9,10,11,12,13,15,16,17,18,
                                                19,20,21,22,23,24,25,26,27,28,29,30,31,
                                                32,33,34,35,36,37,38,39,40,
                                                41,42,44,45,46,47,48,49,50,51,53,54,55,56,72), 
                       labels = c("Alabama", "Alaska", "Arizona", "Arkansas",
                                  "California", "Colorado", "Connecticut",
                                  "Delaware", "DC", "Florida", "Georgia",
                                  "Hawaii", "Idaho", "Illinois", "Indiana",
                                  "Iowa", "Kansas", "Kentucky", "Louisiana",
                                  "Maine", "Maryland", "Massachusetts", 
                                  "Michigan", "Minnesota", "Mississippi",
                                  "Missouri", "Montana", "Nebraska", "Nevada", 
                                  "New Hampshire", "New Jersey", "New Mexico", 
                                  "New York", "North Carolina", "North Dakota", 
                                  "Ohio", "Oklahoma", "Oregon", "Pennsylvania", 
                                  "Rhode Island", "South Carolina", "South Dakota",
                                  "Tennessee", "Texas", "Utah", "Vermont", 
                                  "Virginia", "Washington", "West Virginia",
                                  "Wisconsin", "Wyoming", "PuertoRico"
                                  ))

# renaming region
mydata$region <- factor(mydata$region, levels = c(1,2,3,4,9), labels = c("NorthEast", "MidWest", 
                                                                   "South", "West", "PuertoRico"))

# creating age-grouping
mydata <- mydata %>%
  mutate(agegroup = factor(case_when(
    age >= 65 ~ "senior",
    age >= 21 & age <=64 ~ "adult",
    age >= 15 & age <= 20 ~ "youth",
    age <=15 ~ "children"
  )))


# rename worker_class
# N/A - Not in universe (less than 16 years old/NILF who last worked more than 5 years ago or never worked)
mydata$worker_class <- factor(mydata$worker_class, levels = c(1:9), labels = c(
  "Private", "NonProfit", "LocalGovt", "StGovt",
  "FedGovt", "SelfEmployed", "SoleProp", "SolePropNoPay", "Unemployed"
))

# rename marital status
mydata$marital_status <- factor(mydata$marital_status, levels = c(1:5), 
                         labels = c("married", "widowed", "divorced", 
                          "separated", "unmarried/under15"))

# rename education
# N/A (less than 3 years old)
mydata$educ_attainment <- factor(mydata$educ_attainment, levels = c(1:24), 
                                 labels = c("NoSchooling", "preschooling",
                                 "kingergarten", "grade1", "grade2", "grade3",
                                 "grade4", "grade5", "grade6", "grade7", "grade8",
                                 "grade9", "grade10", "grade11", "grade12-no diploma",
                                 "HighSchool", "GED/Alternative", "collage_less1yr",
                                 "incompleteCollage", "AssociateDegree",
                                 "Bachelors", "Masters", "ProfessionalDegree", "Doctorate"))

# renaming Employed parents
# N/A - (not own child of householder, and not child in subfamily)
mydata$employ_parents <- factor(mydata$employ_parents, levels = c(1:8),
                         labels = c("BothParentsWrk", "BothDadWrk",
                                    "BothMumWrk", "BothNeitherWrk",
                                    "SingleWrkDad", "SingleUnempDad",
                                    "SingleWrkMum", "SingleUnempMum"))

# employment status
# N/A - (less than 16 years old)
mydata$employment_status <- factor(mydata$employment_status, levels = c(1:6),
                            labels = c("CivEmployedProper", "CivEmployednotwork",
                            "unemployed", "militarywork", "militaryunemployed",
                            "NotInLabourForce"))

# renaming health-coverage
mydata$health_coverage <- factor(mydata$health_coverage, levels = c(1:2),
                                 labels = c("HasCoverage", "NoCoverage"))

# renaming race
mydata$race <- factor(mydata$race, levels = c(1:9),
               labels = c("White", "Black",
                      "Native", "Alaska_native",
                      "MixedNativeAndAlaskan", "Asian",
                      "Hawaiian", "other", "TwoOrMore"))

# renaming stem
# N/A - (less than a bachelor's degree)
mydata$stem <- factor(mydata$stem, levels = c(1,2), labels = c("STEMdegree", "NonSTEMdegree"))

# Adjusting income for inflation
mydata <- mydata %>%
  mutate(
    adjustedincome = income*(inc_adjustment/1000000))

save(mydata, file = "mydata.RData")
load("mydata.RData")

######################################################
################# End of pre-processing ##############
######################################################




######################################################
################# Data Summary #######################
######################################################

## Note1: for inline comments, I have assigned some outputs to variables. ##
## This is to save RAM space, since I later remove the data subset.##

# Proportion of races
f <- wpct(mydata$race, weight = mydata$person_weight)
f %>%
  kbl(caption = "Proportion of races") %>%
  kable_classic(full_width = F, html_font = "Cambria")

g <- wpct(mydata$sex, weight = mydata$person_weight)
g %>%
  kbl(caption = "Proportion of Sex") %>%
  kable_classic(full_width = F, html_font = "Cambria")

## Variables for inline
a1 <- f[[1]]*100
a2 <- f[[2]]*100
a3 <- f[[6]]*100
a4 <- g[[1]]*100
a5 <- g[[2]]*100
remove(f,g)




# Proportion of Educational attainment by race
mydata %>%
  filter(race %in% c("White", "Black", "Asian")) %>%
  filter(educ_attainment %in% c("HighSchool", "ProfessionalDegree", "Bachelors", "Masters", "Doctorate", "AssociateDegree")) %>%
  count(race, educ_attainment) %>%
  group_by(race) %>%
  mutate(percent = (n/sum(n)) * 100) %>%
  ungroup() %>%
  hchart("column", hcaes(x = educ_attainment, y=percent, group = race))



# Median income by state
aa <- mydata %>%
  select(adjustedincome, state, person_weight) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(state) %>%
  summarise(Median_income = weighted.median(adjustedincome, person_weight))
plot_usmap(data = aa, values = "Median_income", colour = "red") +
  scale_fill_continuous(name = "Weighted Median income by State (2018)", label = scales::comma) + 
  theme(legend.position = "right")
remove(aa)




# STEM degree vs. Non-STEM degree holders
steem <- mydata %>%
  select(stem, person_weight) %>%
  filter(!is.na(stem))
d1 <- wpct(steem$stem, weight = steem$person_weight)
d1 %>%
  kbl(caption = "Proportion Post Secondary degrees in STEM field and Non-STEM field") %>%
    kable_classic(full_width = F, html_font = "Cambria")
b1 <- d1[[2]]*100
b2 <- d1[[1]]*100
remove(steem, d1)





# A5. Job Category of the population. 
sc <- mydata %>%
  select(worker_class, person_weight) %>%
  filter(!is.na(worker_class))
d2 <- wpct(sc$worker_class, weight = sc$person_weight)
d2 %>%
  kbl(caption = "Proportion of workers by job category") %>%
    kable_classic(full_width = F, html_font = "Cambria")
remove(sc, d2)




# A6. Mean hours worked by race.
vb <- mydata %>%
  select(race, hrs_worked, person_weight, sex) %>%
  filter(!is.na(hrs_worked)) %>%
  group_by(race, sex) %>%
  summarise(MeanHrsWorked = weighted.mean(x=hrs_worked, w= person_weight))
vb %>%
  kbl() %>%
  kable_classic_2(full_width = F)
remove(vb)




# A7. Hours worked and sex
mydata %>%
  filter(!is.na(hrs_worked)) %>%
  filter(!is.na(adjustedincome)) %>%
  select(adjustedincome, sex, hrs_worked, person_weight) %>%
  group_by(sex, hrs_worked) %>%
  summarise(avg.inc = weighted.mean(adjustedincome, person_weight)) %>%
  hchart("scatter", hcaes(x = hrs_worked, y= avg.inc, group = sex))




# A8. Educational attainment and Average Income
fy <- mydata %>%
  filter(educ_attainment %in% c("HighSchool", "ProfessionalDegree", "Bachelors", "Masters", "Doctorate","AssociateDegree")) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(educ_attainment) %>%
  summarise(avg.inc = weighted.mean(adjustedincome, person_weight))
hchart(fy, type = "column", hcaes(x = educ_attainment, y = avg.inc)) %>%
  hc_xAxis(title = list(text = "<b>Educational attainment<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Average Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Educational attainment<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
b3 <- fy[[5,1]]
remove(fy)




# A9. Job category and Income
hj <- mydata %>%
  filter(!worker_class %in% c("Unemployed", "SoleProp", "SolePropNoPay")) %>%
  filter(!is.na(worker_class)) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(worker_class) %>%
  summarise(avg.inc = weighted.mean(adjustedincome, person_weight))
hchart(hj, type = "column", hcaes(x = worker_class, y = avg.inc)) %>%
  hc_xAxis(title = list(text = "<b>Job Category<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Average Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Job Category<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())

## Variables for inline
b4 <- hj[[5,1]]
remove(hj)





######################################################
################# Methodology ########################
######################################################




# B1. Income distribution
inco <- mydata %>%
  select(adjustedincome, person_weight, agegroup) %>%
  filter(!agegroup %in% "children") %>%
  filter(!is.na(adjustedincome)) %>%
  mutate(TaxBracket = factor(case_when(
    adjustedincome >= 500001 ~ "Bracket 7",
    adjustedincome >= 200001 & adjustedincome <= 500000 ~ "Bracket 6",
    adjustedincome >= 157501 & adjustedincome <= 200000 ~ "Bracket 5",
    adjustedincome >= 82501 & adjustedincome <= 157500 ~ "Bracket 4",
    adjustedincome >= 38701 & adjustedincome <= 82500 ~ "Bracket 3",
    adjustedincome >= 9526 & adjustedincome <= 38700 ~ "Bracket 2",
    adjustedincome >= 0 & adjustedincome <= 9525 ~ "Bracket 1",
    adjustedincome < 0 ~ "NegativeIncome")))
ggplot(data=subset(inco, !is.na(TaxBracket)), aes(x=TaxBracket, weight = person_weight)) + 
  geom_histogram(stat = "count", color="black", fill="lightblue", linetype="dashed") + 
  scale_y_continuous(name = "Count (millions)",labels = function(y) y / 1000000)
remove(inco)




# B2. Income vs Race vs Educational Attainment
tt <- c("HighSchool", "ProfessionalDegree", "Bachelors", "Masters", "Doctorate", "AssociateDegree")
rr <- c("White", "Black", "Asian")
ww <- mydata %>%
  filter(educ_attainment %in% tt) %>%
  filter(race %in% rr) %>%
  filter(agegroup == "adult") %>%
  group_by(race, educ_attainment) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight))
hchart(ww, type = "bar", hcaes(x = educ_attainment, y = avginc, group = race)) %>%
  hc_xAxis(title = list(text = "<b>Educcation<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Race vs Education<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
remove(ww, tt, rr)




# B3. Educational attainment and sex and Income
e <- c("HighSchool", "ProfessionalDegree", "Bachelors", "Masters", "Doctorate", "AssociateDegree")
c <- mydata %>%
  filter(educ_attainment %in% e) %>%
  filter(agegroup == "adult") %>%
  group_by(sex, educ_attainment) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight))
hchart(c, type = "bar", hcaes(x = educ_attainment, y = avginc, group = sex)) %>%
  hc_xAxis(title = list(text = "<b>Education<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Sex vs Education<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
remove(c,e)





# B4. Race and Job Type. 
mydata %>%
  filter(!is.na(worker_class)) %>%
  filter(!worker_class %in% c("Unemployed", "SoleProp", "SolePropNoPay")) %>%
  filter(race %in% c("White", "Black", "Asian")) %>%
  count(worker_class, race) %>%
  group_by(race) %>%
  mutate(percent = (n/sum(n)) * 100) %>%
  ungroup() %>%
  ggplot(aes(x=worker_class, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer(palette = "Set2") +
  ggtitle("Race and Job category")
# Sex and Job Type
mydata %>%
  filter(!is.na(worker_class)) %>%
  filter(!worker_class %in% c("Unemployed", "SoleProp", "SolePropNoPay")) %>%
  count(worker_class, sex) %>%
  group_by(sex) %>%
  mutate(percent = (n/sum(n)) * 100) %>%
  ungroup() %>%
  ggplot(aes(x=worker_class, y = percent, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer(palette = "Set3") +
  ggtitle("Sex and Job category")





# B5. STEM degree and income. STEM degree and race.
yu <- mydata %>%
  filter(!is.na(stem)) %>%
  group_by(sex, stem) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight))
hchart(yu, type = "bar", hcaes(x = stem, y = avginc, group = sex)) %>%
  hc_xAxis(title = list(text = "<b>STEM<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Sex vs Stem<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
remove(yu)

# Income vs Race vs STEM
test <- mydata %>%
  filter(!is.na(stem)) %>%
  group_by(race, stem) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight))
hchart(test, type = "column", hcaes(x = stem, y = avginc, group = race)) %>%
  hc_xAxis(title = list(text = "<b>STEM<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Race vs STEM degree<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
remove(test)






# B6. Average hours worked vs Income vs Race
rr <- c("White", "Black", "Asian")
tt <- c("HighSchool", "ProfessionalDegree", "Bachelors", "Masters", "Doctorate", "AssociateDegree")
mydata %>%
  filter(race %in% rr) %>%
  filter(!is.na(hrs_worked)) %>%
  filter(!is.na(adjustedincome)) %>%
  select(adjustedincome, race, hrs_worked, person_weight) %>%
  group_by(race, hrs_worked) %>%
  summarise(avg.inc = weighted.mean(adjustedincome, person_weight)) %>%
  hchart("scatter", hcaes(x = hrs_worked, y= avg.inc, group = race))
remove(tt,rr)



######################################################
################# Findings ###########################
######################################################




# C1. Income ineqality between White and Black in USA
yy <- mydata %>%
  select(adjustedincome, race, person_weight, state) %>%
  filter(race %in% c("White", "Black")) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(state, race) %>%
  summarise(Median_income = weighted.median(adjustedincome, person_weight)) 

yt <- spread(yy, key = race, value = Median_income)

ye <-yt %>%
  mutate(IncomeDifference = White - Black)
ye %>%
  select(state, IncomeDifference) %>%
  arrange(desc(IncomeDifference))
plot_usmap(data = ye, values = "IncomeDifference", colour = "green") +
  scale_fill_continuous(name = "Median income Disparity between Blacks and White", low = "grey", high = "blue", label = scales::comma) + 
  theme(legend.position = "right")
remove(ye,yt,yy)






# C2. ANOVA test - education attainment and average income
bn <- mydata %>%
  select(adjustedincome, person_weight, educ_attainment) %>%
  filter(!is.na(adjustedincome)) %>%
  filter(educ_attainment %in% c("ProfessionalDegree", "Bachelors", "Masters", "Doctorate", "AssociateDegree")) %>%
  group_by(educ_attainment)

rt <- aov(adjustedincome ~ educ_attainment, data = bn, weight = person_weight)
summary(rt)
remove(bn, rt)





# C3. ANOVA test - Job Category and average income
b <- mydata %>%
  select(person_weight, adjustedincome, worker_class) %>%
  filter(!is.na(adjustedincome)) %>%
  filter(!is.na(worker_class)) %>%
  filter(!worker_class %in% c("Unemployed", "SoleProp", "SolePropNoPay", "Private", "NonProfit",
                              "SelfEmployed")) %>%
  group_by(worker_class)
av <- aov(adjustedincome ~ worker_class, data = b, weight = person_weight)
summary(av)
remove(b,av)





# C4. Two sample t-test
fh<- mydata %>%
  select(stem, adjustedincome) %>%
  filter(!is.na(stem)) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(stem) %>%
  arrange(adjustedincome)

### Shapiro test to see normality. First 5000 since dataset is huge and can't do shapiro test on a size beyond 5000.
stest <- shapiro.test(fh$adjustedincome[0:5000])
# p value is less than 0.05

c1 <- fh %>%
  mutate(id = row_number()) %>%
  spread(key = stem, value = adjustedincome)
c2 <- c1 %>%
  na.omit()
remove(c1)

bm<- t.test(c2$STEMdegree, c2$NonSTEMdegree, paired=T)
bm

## Variables for inline
b7 <- bm$p.value
b8 <- bm$statistic[[1]]

remove(c2, fh, stest, bm)





# C5. Linear regression
## Model graph
mydata %>%
  select(hrs_worked, adjustedincome, person_weight) %>%
  group_by(hrs_worked) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight)) %>%
  ggplot(aes(x=hrs_worked, y= avginc)) + geom_point() + geom_smooth(method=lm)

lmodel <- mydata %>%
  select(hrs_worked, adjustedincome, person_weight) %>%
  filter(!is.na(hrs_worked)) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(hrs_worked)

mod1 <- lm(adjustedincome ~ hrs_worked, data = lmodel, weights = person_weight)
summary(mod1)

### Correlation
with(lmodel, cor(hrs_worked, adjustedincome))

## Variables for inline
x1 <- mod1$coef
x2 <- mod1.coef["hrs_worked", "Estimate"]
x3 <- mod1.coef["(Intercept)", "Pr(>|t|)"]
x4 <- mod1.coef["hrs_worked", "Pr(>|t|)"]
x5 <- mod1.coef["hrs_worked", "Estimate"]
x6 <- mod1.coef["hrs_worked", "Std. Error"]
x7 <- summary(mod1)$adj.r.squared
x8 <- summary(mod1)$fstatistic[["value"]]
x25 <- format(formula(mod1))

remove(lmodel, mod1, mod1.coef)





# C6. Multiple Linear Regresison 
lmodel1 <- mydata %>%
  select(hrs_worked, adjustedincome, person_weight, sex, educ_attainment) %>%
  filter(educ_attainment %in% c("HighSchool", "ProfessionalDegree", "Bachelors", "Masters", "Doctorate", "AssociateDegree")) %>%
  filter(!is.na(hrs_worked)) %>%
  filter(!is.na(adjustedincome)) %>%
  group_by(hrs_worked)
mod2 <- lm(adjustedincome ~ hrs_worked + sex + educ_attainment, data = lmodel1, weights = person_weight)
summary(mod2)
mod2.coef <- summary(mod2)$coef

## Variables for inline
z1 <- mod2$coef[["(Intercept)"]]
z2 <- mod2$coef[["hrs_worked"]]
z3 <- mod2$coef[["sexFemale"]]
z15<- mod2$coef[["educ_attainmentAssociateDegree"]]
z4 <- mod2$coef[["educ_attainmentBachelors"]]
z5 <- mod2$coef[["educ_attainmentMasters"]]
z6 <- mod2$coef[["educ_attainmentProfessionalDegree"]]
z7 <- mod2$coef[["educ_attainmentDoctorate"]]
z8 <- mod2.coef["(Intercept)", "Pr(>|t|)"]
z9 <- sqrt(deviance(mod2)/df.residual(mod2))
z10 <- summary(mod2)$adj.r.squared
z11 <- summary(mod2)$fstatistic[["value"]]

remove(lmodel1, mod2, mod2.coef)


######################################################
################# End ################################
######################################################
```


# Appendix 2

```{r, eval=FALSE}

##### Things that did not produce anything worthwhile ########


# Average incomes of those who lack healthcare coverage by sex
c <- mydata %>%
  filter(agegroup == "adult") %>%
  group_by(sex, health_coverage) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight))

hchart(c, type = "bar", hcaes(x = health_coverage, y = avginc, group = sex)) %>%
  hc_xAxis(title = list(text = "<b>Health Coverage<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Sex vs HealthCoverage<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
remove(c)


# Average incomes of those who lack healthcare coverage by race
u <- mydata %>%
  filter(agegroup == "adult") %>%
  group_by(race, health_coverage) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight))

hchart(u, type = "column", hcaes(x = health_coverage, y = avginc, group = race)) %>%
  hc_xAxis(title = list(text = "<b>Health Coverage<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs race vs HealthCoverage<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
remove(u)

# Average incomes of those who lack healthcare coverage by job area
mydata %>%
  filter(agegroup == "adult") %>%
  group_by(worker_class, health_coverage) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight))%>%
  hchart(type = "column", hcaes(x = health_coverage, y = avginc, group = worker_class)) %>%
  hc_xAxis(title = list(text = "<b>Health Coverage<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs Worker class vs HealthCoverage<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
# Sole props are without healthcare coverage

# Regions with no healthcare coverage
mydata %>%
  filter(agegroup == "adult") %>%
  group_by(region, health_coverage) %>%
  summarise(avginc = weighted.mean(adjustedincome, person_weight))%>%
  hchart(type = "column", hcaes(x = health_coverage, y = avginc, group = region)) %>%
  hc_xAxis(title = list(text = "<b>Health Coverage<b>", colour = "black")) %>%
  hc_yAxis(title = list(text = "<b>Income<b>"), colour = "black") %>%
  hc_title(text = "<b>Income vs region vs HealthCoverage<b>", align = "centre", colour = "black") %>%
  hc_add_theme(hc_theme_flat())
# Northwest is the region with highest incomes among the no heath coverage group

```
















